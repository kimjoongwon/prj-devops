# 확장 및 사용자 정의

<cite>
**이 문서에서 참조한 파일**  
- [README.md](file://README.md)
- [environments/argocd/app-of-apps.yaml](file://environments/argocd/app-of-apps.yaml)
- [environments/argocd/apps/plate-api-stg.yaml](file://environments/argocd/apps/plate-api-stg.yaml)
- [environments/argocd/apps/plate-api-prod.yaml](file://environments/argocd/apps/plate-api-prod.yaml)
- [environments/argocd/apps/plate-web-stg.yaml](file://environments/argocd/apps/plate-web-stg.yaml)
- [environments/argocd/apps/plate-web-prod.yaml](file://environments/argocd/apps/plate-web-prod.yaml)
- [environments/argocd/apps/plate-llm-stg.yaml](file://environments/argocd/apps/plate-llm-stg.yaml)
- [environments/argocd/apps/plate-cache-stg.yaml](file://environments/argocd/apps/plate-cache-stg.yaml)
- [environments/argocd/apps/plate-cache-prod.yaml](file://environments/argocd/apps/plate-cache-prod.yaml)
- [helm/applications/plate-server/values.yaml](file://helm/applications/plate-server/values.yaml)
- [helm/applications/plate-server/values-stg.yaml](file://helm/applications/plate-server/values-stg.yaml)
- [helm/applications/plate-server/values-prod.yaml](file://helm/applications/plate-server/values-prod.yaml)
- [helm/applications/plate-web/values.yaml](file://helm/applications/plate-web/values.yaml)
- [helm/applications/plate-web/values-stg.yaml](file://helm/applications/plate-web/values-stg.yaml)
- [helm/applications/plate-web/values-prod.yaml](file://helm/applications/plate-web/values-prod.yaml)
- [helm/applications/plate-llm/values.yaml](file://helm/applications/plate-llm/values.yaml)
- [helm/applications/plate-llm/values-stg.yaml](file://helm/applications/plate-llm/values-stg.yaml)
- [helm/applications/plate-cache/values.yaml](file://helm/applications/plate-cache/values.yaml)
- [helm/applications/plate-cache/values-stg.yaml](file://helm/applications/plate-cache/values-stg.yaml)
- [helm/shared-configs/openbao-secrets-manager/values.yaml](file://helm/shared-configs/openbao-secrets-manager/values.yaml)
- [scripts/deploy-all.sh](file://scripts/deploy-all.sh)
- [scripts/deploy-libraries.sh](file://scripts/deploy-libraries.sh)
</cite>

## 목차
1. [소개](#소개)
2. [새 환경 추가](#새-환경-추가)
3. [새 애플리케이션 추가](#새-애플리케이션-추가)
4. [인프라 수정](#인프라-수정)
5. [Helm 차트 구성 확장](#helm-차트-구성-확장)
6. [ArgoCD를 통한 환경별 설정 오버라이드](#argocd를-통한-환경별-설정-오버라이드)
7. [사용자 정의 예시: 스테이징 환경 추가](#사용자-정의-예시-스테이징-환경-추가)
8. [결론](#결론)

## 소개

이 문서는 `prj-devops` 프로젝트의 확장성과 사용자 정의 가능성을 설명합니다. 이 시스템은 Helm과 ArgoCD를 기반으로 한 GitOps 아키텍처를 사용하여, 새 환경 추가, 새 애플리케이션 배포, 인프라 수정 등의 작업을 체계적으로 수행할 수 있도록 설계되었습니다. 사용자는 Helm 차트의 `values.yaml` 파일과 ArgoCD의 `valueFiles` 설정을 통해 시스템을 자신의 요구에 맞게 확장하고 사용자 정의할 수 있습니다.

**소스 정보**
- [README.md](file://README.md#L317-L322)
- [environments/argocd/README.md](file://environments/argocd/README.md#L16-L38)

## 새 환경 추가

새 환경(예: 개발, QA, UAT 등)을 추가하는 절차는 다음과 같습니다.

1. **환경 디렉터리 생성**: `environments/` 디렉터리 아래에 새 환경 이름으로 디렉터리를 생성합니다. 예: `environments/qa/`.
2. **환경 전용 values 파일 작성**: 각 애플리케이션 Helm 차트에 해당 환경 전용 `values-qa.yaml` 파일을 생성하고, 환경에 맞는 설정(예: replicaCount, resource limits, image tag 등)을 정의합니다.
3. **ArgoCD Application 정의 추가**: `environments/argocd/apps/` 디렉터리에 `<서비스>-qa.yaml` 형식으로 ArgoCD Application 리소스를 생성합니다. 이 파일은 `spec.source.helm.valueFiles`에 `- values-qa.yaml`을 포함시켜야 합니다.
4. **스크립트 조건 추가 (선택)**: `scripts/deploy-all.sh`와 같은 배포 스크립트에 새 환경에 대한 조건 분기를 추가하여 배포를 자동화할 수 있습니다.

이러한 절차를 따르면, Git 저장소에 변경 사항을 커밋하고 ArgoCD가 감지하면 자동으로 새 환경에 애플리케이션이 배포됩니다.

**소스 정보**
- [README.md](file://README.md#L317-L322)
- [environments/argocd/README.md](file://environments/argocd/README.md#L40-L58)

## 새 애플리케이션 추가

새 애플리케이션을 시스템에 추가하는 절차는 다음과 같습니다.

1. **Helm 차트 생성**: `helm/applications/` 디렉터리 아래에 새 애플리케이션 이름으로 디렉터리를 생성합니다. 예: `helm/applications/my-new-app/`.
2. **기본 values.yaml 작성**: `values.yaml` 파일을 생성하여 애플리케이션의 기본 구성(예: image, replicaCount, service type 등)을 정의합니다.
3. **환경별 values 파일 작성**: `values-stg.yaml` 및 `values-prod.yaml` 파일을 생성하여 스테이징과 프로덕션 환경에 맞는 오버라이드 설정을 정의합니다.
4. **ArgoCD Application 정의 추가**: `environments/argocd/apps/` 디렉터리에 `my-new-app-stg.yaml` 및 `my-new-app-prod.yaml` 파일을 생성합니다. 각 파일은 `spec.source.path`를 `helm/applications/my-new-app`으로 설정하고, `spec.destination.namespace`를 해당 환경의 네임스페이스로 지정합니다.
5. **App of Apps에 추가 (선택)**: `environments/argocd/app-of-apps.yaml`의 `spec.source.helm.parameters`에 새 애플리케이션의 ArgoCD Application을 포함시켜 전체 배포 흐름에 통합할 수 있습니다.

이렇게 하면 새 애플리케이션이 기존의 GitOps 워크플로우에 완전히 통합됩니다.

**소스 정보**
- [README.md](file://README.md#L323-L327)
- [environments/argocd/app-of-apps.yaml](file://environments/argocd/app-of-apps.yaml)

## 인프라 수정

클러스터 서비스 또는 개발 도구와 같은 인프라 구성 요소를 수정하는 절차는 다음과 같습니다.

1. **해당 Helm 차트 수정**: `helm/cluster-services/` 또는 `helm/development-tools/` 디렉터리 내에서 수정할 차트의 `values.yaml` 파일을 변경합니다. 예: `helm/cluster-services/cert-manager/values.yaml`.
2. **변경 사항 검토**: `helm lint` 및 `helm template` 명령어를 사용하여 변경 사항의 유효성을 검사합니다.
3. **스테이징 환경에서 검증**: 변경 사항을 스테이징 환경에 적용하고, 기능 및 성능을 검증합니다.
4. **프로덕션 환경에 반영**: 검증이 완료되면 변경 사항을 프로덕션 환경에 반영하고, 변경 내역을 문서화합니다.

인프라 변경은 애플리케이션 변경보다 더 신중하게 다뤄야 하며, 반드시 스테이징 환경에서 충분한 검증을 거쳐야 합니다.

**소스 정보**
- [README.md](file://README.md#L329-L333)
- [scripts/deploy-libraries.sh](file://scripts/deploy-libraries.sh)

## Helm 차트 구성 확장

Helm 차트의 `values.yaml` 파일을 통해 구성 확장을 수행할 수 있습니다. 이 파일은 애플리케이션의 모든 구성 가능한 파라미터를 정의합니다. 예를 들어, `plate-api` 애플리케이션의 `values.yaml`에는 다음과 같은 항목들이 포함되어 있습니다:

- **replicaCount**: Pod의 복제본 수
- **image**: 컨테이너 이미지 저장소 및 태그
- **resources**: CPU 및 메모리 리소스 제한과 요청
- **ingress**: Ingress 리소스 설정 및 TLS 구성
- **appSecrets**: 외부 비밀 관리자(OpenBao)를 통해 주입할 환경 변수 목록

사용자는 이 파일을 기반으로 환경별로 필요한 설정을 오버라이드할 수 있습니다. 예를 들어, 프로덕션 환경에서는 `replicaCount`를 증가시키고, `image.tag`를 고정된 버전으로 설정할 수 있습니다.

**소스 정보**
- [helm/applications/plate-server/values.yaml](file://helm/applications/plate-server/values.yaml)
- [helm/applications/plate-web/values.yaml](file://helm/applications/plate-web/values.yaml)
- [helm/applications/plate-llm/values.yaml](file://helm/applications/plate-llm/values.yaml)

## ArgoCD를 통한 환경별 설정 오버라이드

ArgoCD는 `valueFiles` 필드를 통해 환경별 설정 오버라이드를 지원합니다. 각 ArgoCD Application 리소스는 `spec.source.helm.valueFiles` 배열을 사용하여 하나 이상의 values 파일을 지정할 수 있습니다. 예를 들어, `plate-api-stg.yaml` 파일은 다음과 같이 구성됩니다:

```yaml
spec:
  source:
    path: helm/applications/plate-server
    helm:
      valueFiles:
        - values-stg.yaml
```

이 설정은 ArgoCD가 `helm/applications/plate-server/values-stg.yaml` 파일의 내용을 `values.yaml`의 기본값 위에 오버라이드하도록 지시합니다. 이 방식을 통해 스테이징과 프로덕션 환경 간에 서로 다른 구성(예: 리소스 요청, 이미지 태그, replica 수)을 쉽게 관리할 수 있습니다.

**소스 정보**
- [environments/argocd/apps/plate-api-stg.yaml](file://environments/argocd/apps/plate-api-stg.yaml#L19-L21)
- [environments/argocd/apps/plate-api-prod.yaml](file://environments/argocd/apps/plate-api-prod.yaml#L19-L21)

## 사용자 정의 예시: 스테이징 환경 추가

기존에 스테이징(staging)과 프로덕션(production) 환경이 존재할 때, 새로운 QA 환경을 추가하는 구체적인 예시를 살펴보겠습니다.

1. **Helm 차트에 QA values 파일 추가**:
   - `helm/applications/plate-server/values-qa.yaml` 생성
   - 내용: `replicaCount: 2`, `image.tag: "qa-latest"`, `resources.requests.memory: "256Mi"`

2. **ArgoCD Application 정의 생성**:
   - `environments/argocd/apps/plate-api-qa.yaml` 생성
   - `spec.destination.namespace: plate-qa`
   - `spec.source.helm.valueFiles: - values-qa.yaml`

3. **배포 스크립트 업데이트**:
   - `scripts/deploy-all.sh`에 `qa` 환경에 대한 분기 추가
   - `deploy_application()` 함수에 `qa` 케이스 추가

이렇게 하면 `./scripts/deploy-all.sh qa` 명령어를 통해 QA 환경에 애플리케이션을 배포할 수 있습니다.

**소스 정보**
- [helm/applications/plate-server/values-stg.yaml](file://helm/applications/plate-server/values-stg.yaml)
- [environments/argocd/apps/plate-api-stg.yaml](file://environments/argocd/apps/plate-api-stg.yaml)
- [scripts/deploy-all.sh](file://scripts/deploy-all.sh#L136-L150)

## 결론

`prj-devops` 프로젝트는 높은 수준의 확장성과 사용자 정의 가능성을 제공합니다. Helm 차트의 `values.yaml` 파일과 ArgoCD의 `valueFiles` 메커니즘을 활용하면, 다양한 환경을 쉽게 추가하고 관리할 수 있으며, 각 애플리케이션과 인프라 구성 요소를 세밀하게 조정할 수 있습니다. 이 구조는 GitOps 원칙을 따르며, 모든 변경 사항이 형상 관리에 기록되어 추적 가능하고, 반복 가능한 배포를 보장합니다. 사용자는 이 문서의 지침을 따라 시스템을 자신의 요구에 맞게 유연하게 확장하고 사용자 정의할 수 있습니다.