# 문제 해결

<cite>
**이 문서에서 참조한 파일**
- [README.md](file://README.md)
- [environments/argocd/app-of-apps.yaml](file://environments/argocd/app-of-apps.yaml)
- [environments/argocd/apps/plate-web-stg.yaml](file://environments/argocd/apps/plate-web-stg.yaml)
- [environments/argocd/apps/plate-api-prod.yaml](file://environments/argocd/apps/plate-api-prod.yaml)
- [helm/development-tools/argocd/values.yaml](file://helm/development-tools/argocd/values.yaml)
- [helm/cluster-services/cert-manager/values.yaml](file://helm/cluster-services/cert-manager/values.yaml)
- [helm/cluster-services/cert-manager/templates/cluster-issuer-prod.yaml](file://helm/cluster-services/cert-manager/templates/cluster-issuer-prod.yaml)
- [helm/cluster-services/cert-manager/templates/cluster-issuer-staging.yaml](file://helm/cluster-services/cert-manager/templates/cluster-issuer-staging.yaml)
- [scripts/deploy-harbor-auth.sh](file://scripts/deploy-harbor-auth.sh)
- [scripts/verify-harbor-auth.sh](file://scripts/verify-harbor-auth.sh)
- [scripts/deploy-all.sh](file://scripts/deploy-all.sh)
</cite>

## 목차
1. [배포 실패 문제 해결](#배포-실패-문제-해결)
2. [ArgoCD 동기화 오류 해결](#argocd-동기화-오류-해결)
3. [인증서 갱신 실패 문제 해결](#인증서-갱신-실패-문제-해결)
4. [Harbor 인증 문제 해결](#harbor-인증-문제-해결)

## 배포 실패 문제 해결

배포가 실패하는 경우, 다음과 같은 점검 절차를 따르는 것이 중요합니다. 먼저, 배포 스크립트의 로그를 확인하고, Kubernetes 리소스 상태를 점검해야 합니다.

### 주요 점검 항목
- **스크립트 실행 로그**: `deploy-all.sh`, `deploy-stg.sh`, `deploy-prod.sh` 스크립트의 출력 로그를 확인하여 오류 메시지를 식별합니다.
- **네임스페이스 존재 여부**: 배포 대상 네임스페이스가 존재하는지 확인합니다. 존재하지 않으면 자동 생성되지만, `CreateNamespace=true` 설정이 필요합니다.
- **리소스 제약 조건**: Pod가 `OOMKilled` 또는 `CrashLoopBackOff` 상태인지 확인하여 리소스 요청/제한 설정을 점검합니다.
- **이미지 풀 오류**: 컨테이너 이미지가 정상적으로 풀(Pull)되는지 확인합니다. Harbor 인증 문제가 원인일 수 있습니다.

### 진단 명령 예시
```bash
# 배포 스크립트 상태 확인
./scripts/deploy-stg.sh status
./scripts/deploy-prod.sh status

# 모든 네임스페이스의 Pod 상태 확인
kubectl get pods -A

# 특정 네임스페이스의 이벤트 확인
kubectl get events -n plate-stg --sort-by=.metadata.creationTimestamp

# Ingress 상태 확인
kubectl get ingress -A
```

**Section sources**
- [README.md](file://README.md#L175-L193)
- [scripts/deploy-all.sh](file://scripts/deploy-all.sh#L1-L279)

## ArgoCD 동기화 오류 해결

ArgoCD 동기화 오류는 Git 저장소와 클러스터 상태 간 불일치로 인해 발생합니다. 동기화 실패 시, 다음과 같은 절차로 문제를 진단하고 해결할 수 있습니다.

### 주요 원인 및 해결 방법
- **Git 저장소 접근 문제**: ArgoCD가 Git 저장소에 접근할 수 없는 경우, 저장소 URL과 인증 정보를 확인해야 합니다.
- **Helm 차트 오류**: Helm 차트 템플릿에 구문 오류가 있는 경우, `helm lint` 명령으로 검증합니다.
- **리소스 충돌**: 이미 존재하는 리소스와 이름이 충돌하는 경우, 기존 리소스를 삭제하거나 이름을 변경합니다.
- **권한 부족**: ArgoCD 서비스 어카운트에 필요한 RBAC 권한이 부여되지 않은 경우, 클러스터 역할과 바인딩을 확인합니다.

### 동기화 재시도 정책
ArgoCD Application은 재시도 정책을 통해 일시적인 오류에 대응할 수 있습니다. 아래는 `plate-web-stg` 애플리케이션의 재시도 설정 예시입니다.

```yaml
syncPolicy:
  retry:
    limit: 5
    backoff:
      duration: 5s
      factor: 2
      maxDuration: 3m
```

이 설정은 최대 5회 재시도하며, 재시도 간 대기 시간은 5초에서 시작하여 2배씩 증가하며, 최대 3분까지 증가합니다.

### 진단 명령 예시
```bash
# ArgoCD CLI로 동기화 상태 확인
argocd app get plate-web-stg

# ArgoCD Application 동기화 시도
argocd app sync plate-web-stg

# ArgoCD 컨트롤러 로그 확인
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-application-controller
```

**Section sources**
- [environments/argocd/apps/plate-web-stg.yaml](file://environments/argocd/apps/plate-web-stg.yaml#L1-L62)
- [helm/development-tools/argocd/values.yaml](file://helm/development-tools/argocd/values.yaml#L1086-L1285)

## 인증서 갱신 실패 문제 해결

cert-manager를 통한 인증서 갱신은 Let's Encrypt ACME 프로토콜을 사용하며, 갱신 실패 시 다음과 같은 점검이 필요합니다.

### 주요 점검 항목
- **ClusterIssuer 설정**: `letsencrypt-prod` 및 `letsencrypt-staging` ClusterIssuer가 올바르게 설정되어 있는지 확인합니다.
- **도메인 DNS 레코드**: 인증서 요청 도메인의 A 또는 CNAME 레코드가 올바른 IP 주소를 가리키는지 확인합니다.
- **Ingress 컨트롤러 상태**: Ingress 컨트롤러가 정상적으로 실행 중인지 확인합니다. HTTP-01 챌린지 해결을 위해 필요합니다.
- **Rate Limit 초과**: Let's Encrypt는 일정 기간 내 인증서 발급 횟수에 제한을 두며, 초과 시 일시적으로 발급이 거부됩니다.

### ClusterIssuer 구성
프로덕션 및 스테이징 환경을 위한 ClusterIssuer는 다음과 같이 정의됩니다.

```yaml
# 프로덕션 ClusterIssuer
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@example.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
      - http01:
          ingress:
            class: nginx

# 스테이징 ClusterIssuer
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: admin@example.com
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
      - http01:
          ingress:
            class: nginx
```

### 진단 명령 예시
```bash
# 모든 인증서 상태 확인
kubectl get certificates -A

# 인증서 상세 정보 확인
kubectl describe certificate -n plate-stg plate-web-tls

# Order 및 Challenge 리소스 확인
kubectl get orders, challenges -A

# cert-manager 컨트롤러 로그 확인
kubectl logs -n cert-manager -l app.kubernetes.io/name=cert-manager
```

**Section sources**
- [helm/cluster-services/cert-manager/values.yaml](file://helm/cluster-services/cert-manager/values.yaml#L1-L35)
- [helm/cluster-services/cert-manager/templates/cluster-issuer-prod.yaml](file://helm/cluster-services/cert-manager/templates/cluster-issuer-prod.yaml#L1-L20)
- [helm/cluster-services/cert-manager/templates/cluster-issuer-staging.yaml](file://helm/cluster-services/cert-manager/templates/cluster-issuer-staging.yaml#L1-L20)

## Harbor 인증 문제 해결

Harbor 인증은 External Secrets Operator(ESO)와 OpenBao를 통해 관리되며, 인증 문제가 발생할 경우 다음과 같은 절차로 점검합니다.

### 주요 점검 항목
- **OpenBao 토큰 설정**: `openbao-token-secret.yaml` 파일에 base64 인코딩된 유효한 토큰이 설정되어 있는지 확인합니다.
- **ESO 설치 상태**: `external-secrets-system` 네임스페이스에 ESO가 정상적으로 설치되고 실행 중인지 확인합니다.
- **SecretStore 및 ExternalSecret 상태**: SecretStore가 연결되었는지, ExternalSecret이 동기화되었는지 확인합니다.
- **Harbor Docker Secret 생성**: `harbor-docker-secret`이 각 네임스페이스에 정상적으로 생성되었는지 확인합니다.

### 검증 스크립트 사용
`verify-harbor-auth.sh` 스크립트를 사용하여 Harbor 인증을 종합적으로 검증할 수 있습니다.

```bash
# Harbor 인증 검증
./scripts/verify-harbor-auth.sh
```

이 스크립트는 다음과 같은 검사를 수행합니다:
1. OpenBao 토큰 설정 확인
2. ESO 설치 및 실행 상태 확인
3. SecretStore 및 ExternalSecret 상태 확인
4. Harbor Docker Secret 생성 확인
5. Harbor 이미지 Pull 테스트

### 문제 해결 가이드
검증 스크립트가 실패할 경우, 다음 절차를 따라 문제를 해결합니다:
1. OpenBao 토큰이 올바르게 설정되었는지 확인합니다.
2. Harbor Robot Account가 활성화되어 있는지 확인합니다.
3. ESO 로그를 확인하여 동기화 오류를 진단합니다.
4. SecretStore와 ExternalSecret의 상태를 수동으로 확인합니다.

**Section sources**
- [scripts/deploy-harbor-auth.sh](file://scripts/deploy-harbor-auth.sh#L1-L194)
- [scripts/verify-harbor-auth.sh](file://scripts/verify-harbor-auth.sh#L91-L212)