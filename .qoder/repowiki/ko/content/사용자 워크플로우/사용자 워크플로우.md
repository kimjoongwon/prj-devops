# 사용자 워크플로우

<cite>
**이 문서에서 참조한 파일**  
- [README.md](file://README.md)
- [deploy-all.sh](file://scripts/deploy-all.sh)
- [deploy-libraries.sh](file://scripts/deploy-libraries.sh)
- [deploy-stg.sh](file://scripts/deploy-stg.sh)
- [deploy-prod.sh](file://scripts/deploy-prod.sh)
- [app-of-apps.yaml](file://environments/argocd/app-of-apps.yaml)
- [values-stg.yaml](file://helm/applications/plate-web/values-stg.yaml)
- [values-prod.yaml](file://helm/applications/plate-web/values-prod.yaml)
</cite>

## 목차
1. [소개](#소개)
2. [핵심 진입점 개요](#핵심-진입점-개요)
3. [인프라 및 도구 배포 워크플로우](#인프라-및-도구-배포-워크플로우)
4. [애플리케이션 배포 워크플로우](#애플리케이션-배포-워크플로우)
5. [상태 확인 및 모니터링](#상태-확인-및-모니터링)
6. [문제 발생 시 롤백 절차](#문제-발생-시-롤백-절차)
7. [전체 사용자 워크플로우 요약](#전체-사용자-워크플로우-요약)

## 소개

이 문서는 `prj-devops` 프로젝트의 일반적인 사용자 시나리오와 워크플로우를 단계별로 안내합니다. 사용자는 이 문서를 따라 인프라 및 도구 배포, 애플리케이션 배포, 상태 확인, 문제 발생 시 롤백 등의 일련의 과정을 이해하고 수행할 수 있습니다. 각 시나리오에서 사용되는 주요 스크립트인 `deploy-all.sh`, `deploy-libraries.sh`, `deploy-stg.sh`, `deploy-prod.sh`의 사용법을 설명하며, 실제 명령어 예제를 제공하여 사용자가 쉽게 실습할 수 있도록 구성되어 있습니다.

**Section sources**
- [README.md](file://README.md#L1-L417)

## 핵심 진입점 개요

`prj-devops` 프로젝트는 사용자 친화적인 배포 오케스트레이션을 위해 여러 핵심 스크립트를 제공합니다. 이들 스크립트는 배포의 복잡성을 추상화하고, 사용자가 간단한 명령어로 전체 시스템을 관리할 수 있도록 합니다.

- **`deploy-all.sh`**: 모든 컴포넌트(인프라, 도구, 애플리케이션)를 오케스트레이션하는 메인 배포 스크립트입니다. 환경을 지정하고 다양한 옵션을 통해 배포 범위를 제어할 수 있습니다.
- **`deploy-libraries.sh`**: 클러스터 서비스(cert-manager, MetalLB)와 개발 도구(ArgoCD, Harbor)를 계층 순서대로 배포하는 스크립트입니다. 인프라와 도구의 초기 설정에 사용됩니다.
- **`deploy-stg.sh`**: 스테이징 환경에 애플리케이션을 배포하는 전용 스크립트입니다. 빠른 반복과 손쉬운 정리를 위해 설계되었습니다.
- **`deploy-prod.sh`**: 프로덕션 환경에 애플리케이션을 배포하는 안전한 스크립트입니다. 사용자 확인, 백업 생성, 헬스 체크 검증 등의 안전장치가 포함되어 있습니다.

이러한 스크립트들은 `scripts/` 디렉터리에 위치하며, 사용자는 이들을 조합하여 다양한 배포 시나리오를 구현할 수 있습니다.

**Section sources**
- [README.md](file://README.md#L101-L108)
- [deploy-all.sh](file://scripts/deploy-all.sh#L1-L279)
- [deploy-libraries.sh](file://scripts/deploy-libraries.sh#L1-L128)
- [deploy-stg.sh](file://scripts/deploy-stg.sh#L1-L173)
- [deploy-prod.sh](file://scripts/deploy-prod.sh#L1-L299)

## 인프라 및 도구 배포 워크플로우

인프라 및 도구의 배포는 전체 시스템 운영의 기반이 되는 첫 번째 단계입니다. 이 과정은 `deploy-libraries.sh` 스크립트를 사용하거나, `deploy-all.sh` 스크립트의 옵션을 활용하여 수행할 수 있습니다.

### 1단계: `deploy-libraries.sh` 직접 실행

가장 간단한 방법은 `deploy-libraries.sh` 스크립트를 직접 실행하는 것입니다. 이 스크립트는 다음과 같은 순서로 컴포넌트를 설치합니다.

```bash
./scripts/deploy-libraries.sh
```

**설치 순서:**
1.  **cert-manager**: 클러스터 서비스 계층 1. Let's Encrypt를 통해 SSL/TLS 인증서를 자동으로 발급하고 관리합니다.
2.  **Jenkins**: 개발 도구 계층 2. CI/CD 파이프라인을 위한 자동화된 빌드 및 테스트 환경을 제공합니다.
3.  **MetalLB**: 클러스터 서비스 계층 1. Bare-metal 클러스터에서 LoadBalancer 타입의 서비스를 제공하는 네트워크 로드 밸런서입니다.

이 스크립트는 Helm을 사용하여 공식 저장소와 프로젝트 내 Helm 차트를 결합하여 배포합니다.

### 2단계: `deploy-all.sh`를 통한 선택적 배포

`deploy-all.sh` 스크립트는 더 유연한 제어를 제공합니다. 인프라와 도구만 배포하고 싶은 경우, `--libraries-only` 옵션을 사용할 수 있습니다.

```bash
# 스테이징 환경에 인프라 및 도구만 배포
./scripts/deploy-all.sh staging --libraries-only

# 프로덕션 환경에 인프라 및 도구만 배포 (드라이런)
./scripts/deploy-all.sh production --libraries-only --dry-run
```

반대로, 이미 인프라가 설정된 상태에서 애플리케이션만 배포하고 싶다면 `--skip-libraries` 옵션을 사용할 수 있습니다.

```bash
# 인프라 배포를 건너뛰고 애플리케이션만 배포
./scripts/deploy-all.sh staging --skip-libraries
```

이러한 옵션들은 초기 설정, 재배포, 또는 특정 컴포넌트의 업데이트 시 매우 유용합니다.

**Section sources**
- [README.md](file://README.md#L119-L124)
- [deploy-libraries.sh](file://scripts/deploy-libraries.sh#L1-L128)
- [deploy-all.sh](file://scripts/deploy-all.sh#L118-L130)

## 애플리케이션 배포 워크플로우

애플리케이션 배포는 스테이징과 프로덕션 환경에 따라 다른 절차와 안전장치를 요구합니다. 이 과정은 `deploy-stg.sh`와 `deploy-prod.sh` 스크립트를 중심으로 진행됩니다.

### 스테이징 환경 배포

스테이징 환경은 개발 및 테스트를 위한 공간이므로, 신속한 배포와 반복이 중요합니다. `deploy-stg.sh` 스크립트는 이 목적에 최적화되어 있습니다.

```bash
# 스테이징 환경에 배포 (기본 명령어)
./scripts/deploy-stg.sh

# 또는 deploy-all.sh를 사용
./scripts/deploy-all.sh staging
./scripts/deploy-all.sh # 기본값이 스테이징
```

**주요 특징:**
- **빠른 반복**: `deploy-stg.sh`는 `helm upgrade --install` 명령을 사용하여 지정된 Helm 차트를 빠르게 배포합니다.
- **환경 설정**: `helm/applications/plate-web/values-stg.yaml`과 같은 환경별 `values` 파일을 사용하여 스테이징 전용 설정(예: `image.tag: "latest"`)을 적용합니다.
- **정리 용이성**: `./scripts/deploy-stg.sh delete` 명령으로 애플리케이션을 쉽게 제거할 수 있습니다.

### 프로덕션 환경 배포

프로덕션 환경은 안정성과 보안이 최우선이므로, 더 엄격한 절차를 따릅니다. `deploy-prod.sh` 스크립트는 여러 안전장치를 포함하고 있습니다.

```bash
# 프로덕션 배포 전 드라이런 (검증용)
./scripts/deploy-all.sh production --dry-run

# 실제 프로덕션 배포
./scripts/deploy-all.sh production
```

**주요 안전장치:**
1.  **사용자 확인**: 스크립트는 실행자가 "yes"를 입력할 때까지 배포를 진행하지 않습니다.
2.  **클러스터 확인**: 현재 연결된 클러스터 이름에 "prod" 또는 "production"이 포함되어 있는지 확인합니다.
3.  **자동 백업**: 배포 전에 현재 릴리스의 설정과 매니페스트를 `./backups/` 디렉터리에 저장합니다.
4.  **헬스 체크 검증**: 배포 후, 파드가 준비 상태가 될 때까지 대기하고 롤아웃 상태를 확인합니다.

이러한 절차는 실수로 인한 서비스 중단을 방지하고, 문제가 발생할 경우 신속한 복구를 가능하게 합니다.

**Section sources**
- [README.md](file://README.md#L131-L153)
- [deploy-stg.sh](file://scripts/deploy-stg.sh#L1-L173)
- [deploy-prod.sh](file://scripts/deploy-prod.sh#L1-L299)
- [values-stg.yaml](file://helm/applications/plate-web/values-stg.yaml#L1-L38)
- [values-prod.yaml](file://helm/applications/plate-web/values-prod.yaml#L1-L39)

## 상태 확인 및 모니터링

배포 후 시스템의 상태를 확인하는 것은 매우 중요합니다. `prj-devops`는 각 환경에 맞는 상태 확인 명령어를 제공합니다.

### 배포 상태 확인

각 전용 배포 스크립트는 `status` 하위 명령어를 지원합니다.

```bash
# 스테이징 환경 상태 확인
./scripts/deploy-stg.sh status

# 프로덕션 환경 상태 확인
./scripts/deploy-prod.sh status
```

이 명령어들은 `helm status`와 `kubectl get pods` 등의 명령을 실행하여, 릴리스 상태, 파드 상태, 서비스 및 인그레스 정보를 출력합니다.

### ArgoCD를 통한 GitOps 상태 확인

이 프로젝트는 ArgoCD의 App-of-Apps 패턴을 사용합니다. `environments/argocd/app-of-apps.yaml` 파일이 모든 하위 애플리케이션을 관리합니다.

```bash
# ArgoCD CLI를 사용하여 전체 애플리케이션 상태 확인
argocd app get cocdev-platform-apps
argocd app list
```

ArgoCD UI를 통해 각 애플리케이션의 동기화 상태, 헬스 상태, 그리고 Git과 Kubernetes 사이의 차이를 시각적으로 확인할 수 있습니다. 이는 GitOps 원칙에 따라 시스템의 실제 상태가 선언된 상태와 일치하는지 검증하는 데 필수적입니다.

**Section sources**
- [README.md](file://README.md#L268-L276)
- [deploy-stg.sh](file://scripts/deploy-stg.sh#L154-L165)
- [deploy-prod.sh](file://scripts/deploy-prod.sh#L270-L282)
- [app-of-apps.yaml](file://environments/argocd/app-of-apps.yaml#L1-L35)

## 문제 발생 시 롤백 절차

문제가 발생한 경우, 신속한 롤백은 서비스 복구의 핵심입니다. `prj-devops`는 두 가지 주요 롤백 방법을 제공합니다.

### 1. Helm 기반 롤백 (`deploy-prod.sh` 사용)

`deploy-prod.sh` 스크립트는 내장된 롤백 기능을 제공합니다. 이는 Helm의 `rollback` 명령을 활용합니다.

```bash
# 프로덕션 환경을 이전 리비전으로 롤백
./scripts/deploy-prod.sh rollback

# 특정 리비전 번호로 롤백 (예: 리비전 2)
./scripts/deploy-prod.sh rollback 2
```

이 방법은 Helm 릴리스 히스토리를 기반으로 하며, `deploy-prod.sh`가 생성한 백업과 함께 사용하면 더욱 안전합니다.

### 2. GitOps 기반 롤백 (Git 커밋 되돌리기)

GitOps의 핵심 원칙은 Git 저장소가 단일 진실 원천(Single Source of Truth)이라는 것입니다. 따라서 가장 근본적인 롤백 방법은 Git에서 이전 커밋으로 되돌리는 것입니다.

```bash
# 이전 커밋으로 되돌리기
git revert <problematic-commit-hash>

# 또는 이전 상태로 리셋 (주의: 리셋은 위험할 수 있음)
git reset --hard HEAD~1
git push origin main
```

이 변경 사항을 Git 저장소에 푸시하면, ArgoCD가 자동으로 감지하고 Kubernetes 클러스터를 이전 상태로 동기화합니다. 이 방법은 인프라, 도구, 애플리케이션의 모든 변경 사항을 일관되게 롤백할 수 있는 가장 강력한 방법입니다.

**Section sources**
- [README.md](file://README.md#L228-L229)
- [deploy-prod.sh](file://scripts/deploy-prod.sh#L277-L281)

## 전체 사용자 워크플로우 요약

새로운 사용자가 `prj-devops`를 처음 사용하여 운영까지 진행하는 전 과정을 요약하면 다음과 같습니다.

1.  **초기 설정**: `./scripts/deploy-libraries.sh`를 실행하여 클러스터 서비스와 개발 도구를 배포합니다. 이는 시스템의 기반을 마련합니다.
2.  **스테이징 배포**: `./scripts/deploy-stg.sh`를 사용하여 스테이징 환경에 애플리케이션을 반복적으로 배포하고 기능을 검증합니다.
3.  **프로덕션 준비**: 스테이징에서의 검증이 완료되면, `./scripts/deploy-all.sh production --dry-run`을 실행하여 프로덕션 배포의 변경 사항을 미리 확인합니다.
4.  **프로덕션 배포**: `./scripts/deploy-all.sh production`을 실행하여 프로덕션 환경에 배포합니다. 스크립트의 안전장치를 통해 신중하게 진행합니다.
5.  **상태 모니터링**: `./scripts/deploy-prod.sh status` 및 ArgoCD UI를 통해 배포 후 시스템 상태를 지속적으로 모니터링합니다.
6.  **문제 발생 시**: 문제가 발생하면, `./scripts/deploy-prod.sh rollback`으로 신속하게 복구하거나, Git 커밋을 되돌려서 근본적인 상태로 롤백합니다.

이러한 워크플로우를 따르면, 사용자는 안정적이고 예측 가능한 방식으로 시스템을 관리할 수 있습니다.

**Section sources**
- [README.md](file://README.md#L111-L308)
- [deploy-all.sh](file://scripts/deploy-all.sh#L218-L279)
- [deploy-libraries.sh](file://scripts/deploy-libraries.sh#L105-L128)
- [deploy-stg.sh](file://scripts/deploy-stg.sh#L134-L151)
- [deploy-prod.sh](file://scripts/deploy-prod.sh#L243-L267)