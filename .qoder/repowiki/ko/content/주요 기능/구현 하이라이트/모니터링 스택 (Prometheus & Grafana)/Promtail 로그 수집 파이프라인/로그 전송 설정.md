# 로그 전송 설정

<cite>
**이 문서에서 참조된 파일**   
- [configmap.yaml](file://helm/development-tools/promtail/templates/configmap.yaml)
- [values.yaml](file://helm/development-tools/promtail/values.yaml)
- [README.md](file://helm/development-tools/promtail/README.md)
</cite>

## 목차
1. [소개](#소개)
2. [클라이언트 구성](#클라이언트-구성)
3. [인증 방식](#인증-방식)
4. [TLS 설정](#tls-설정)
5. [배치 전송 및 타임아웃](#배치-전송-및-타임아웃)
6. [재시도 전략](#재시도-전략)
7. [프로덕션 환경을 위한 모범 사례](#프로덕션-환경을-위한-모범-사례)

## 소개
Promtail은 로컬 로그를 Loki 또는 기타 대상 시스템으로 전송하는 에이전트입니다. 이 문서는 `configmap.yaml` 내부의 `clients` 섹션을 기반으로 로그 전송 설정을 상세히 설명합니다. 설정은 `values.yaml`을 통해 관리되며, 엔드포인트 URL, 인증 방식, TLS 설정, 배치 전송 옵션 및 네트워크 장애 시 재시도 전략을 포함합니다.

**Section sources**
- [README.md](file://helm/development-tools/promtail/README.md#L1-L348)

## 클라이언트 구성
`clients` 섹션은 로그를 전송할 대상 시스템의 엔드포인트 URL을 정의합니다. 기본적으로 Promtail은 `http://loki-gateway/loki/api/v1/push` 주소로 로그를 전송합니다. 이 설정은 `values.yaml` 파일의 `config.clients` 섹션에서 오버라이드할 수 있습니다.

```yaml
config:
  clients:
    - url: http://loki.server/loki/api/v1/push
```

**Section sources**
- [values.yaml](file://helm/development-tools/promtail/values.yaml#L425-L427)
- [README.md](file://helm/development-tools/promtail/README.md#L334-L347)

## 인증 방식
Promtail은 다양한 인증 방식을 지원합니다. 가장 일반적인 방식은 `basic_auth`와 `bearer_token`입니다. `basic_auth`를 사용하면 사용자 이름과 비밀번호를 통해 인증할 수 있습니다.

```yaml
config:
  clients:
    - url: http://loki.server/loki/api/v1/push
      basic_auth:
        username: loki
        password: secret
```

또한 `bearer_token`을 사용하여 토큰 기반 인증을 구성할 수 있습니다.

```yaml
config:
  clients:
    - url: http://loki.server/loki/api/v1/push
      bearer_token: your-bearer-token
```

**Section sources**
- [values.yaml](file://helm/development-tools/promtail/values.yaml#L425-L428)
- [README.md](file://helm/development-tools/promtail/README.md#L334-L347)

## TLS 설정
TLS 설정을 통해 로그 전송 시 보안을 강화할 수 있습니다. `tls_config`을 사용하여 TLS 인증서 및 키를 지정할 수 있습니다.

```yaml
config:
  clients:
    - url: https://loki.server/loki/api/v1/push
      tls_config:
        ca_file: /path/to/ca.crt
        cert_file: /path/to/client.crt
        key_file: /path/to/client.key
        insecure_skip_verify: false
```

**Section sources**
- [values.yaml](file://helm/development-tools/promtail/values.yaml#L425-L428)
- [README.md](file://helm/development-tools/promtail/README.md#L334-L347)

## 배치 전송 및 타임아웃
Promtail은 로그를 배치로 전송하며, 이는 네트워크 효율성을 높이고 성능을 최적화합니다. `batchwait` 및 `batchsize` 옵션을 사용하여 배치 전송의 타임아웃과 크기를 조정할 수 있습니다.

```yaml
config:
  clients:
    - url: http://loki.server/loki/api/v1/push
      batchwait: 1s
      batchsize: 1048576
```

**Section sources**
- [values.yaml](file://helm/development-tools/promtail/values.yaml#L425-L428)
- [README.md](file://helm/development-tools/promtail/README.md#L334-L347)

## 재시도 전략
네트워크 장애 시 Promtail은 로그 전송을 재시도합니다. `backoff` 설정을 통해 재시도 간격과 최대 재시도 횟수를 조정할 수 있습니다.

```yaml
config:
  clients:
    - url: http://loki.server/loki/api/v1/push
      backoff:
        min_period: 100ms
        max_period: 10s
        max_retries: 10
```

**Section sources**
- [values.yaml](file://helm/development-tools/promtail/values.yaml#L425-L428)
- [README.md](file://helm/development-tools/promtail/README.md#L334-L347)

## 프로덕션 환경을 위한 모범 사례
프로덕션 환경에서 로그 전송의 신뢰성을 보장하기 위해 다음과 같은 모범 사례를 따르는 것이 중요합니다:

1. **TLS 사용**: 모든 로그 전송에 TLS를 사용하여 데이터의 기밀성과 무결성을 보장합니다.
2. **인증 강화**: `basic_auth` 또는 `bearer_token`을 사용하여 대상 시스템에 대한 인증을 강화합니다.
3. **배치 전송 최적화**: `batchwait` 및 `batchsize`를 적절히 조정하여 네트워크 효율성과 성능을 균형 있게 유지합니다.
4. **재시도 전략 구성**: 네트워크 장애 시 로그 손실을 방지하기 위해 적절한 재시도 전략을 구성합니다.
5. **모니터링 및 경고**: Promtail의 상태와 로그 전송 성공률을 모니터링하고, 문제 발생 시 즉시 알림을 받을 수 있도록 경고를 설정합니다.

이러한 설정을 통해 Promtail은 안정적이고 신뢰할 수 있는 로그 전송을 보장하며, 프로덕션 환경에서의 로그 관리 요구사항을 충족할 수 있습니다.

**Section sources**
- [values.yaml](file://helm/development-tools/promtail/values.yaml#L425-L428)
- [README.md](file://helm/development-tools/promtail/README.md#L334-L347)