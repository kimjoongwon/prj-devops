# ClusterExternalSecret - 클러스터 전역 시크릿
# 지정된 모든 네임스페이스에 동일한 Secret을 생성
# OpenBao 경로: secret/server/cluster
{{- if .Values.clusterSecrets.enabled }}
apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: {{ .Values.clusterSecrets.name }}
  labels:
    {{- include "openbao-cluster-secrets-manager.labels" . | nindent 4 }}
    app.kubernetes.io/component: cluster-external-secret
spec:
  # 시크릿이 생성될 네임스페이스 선택
  namespaceSelector:
    {{- if .Values.clusterSecrets.namespaceSelector.matchLabels }}
    matchLabels:
      {{- toYaml .Values.clusterSecrets.namespaceSelector.matchLabels | nindent 6 }}
    {{- else }}
    # 지정된 네임스페이스에 생성
    matchExpressions:
      - key: kubernetes.io/metadata.name
        operator: In
        values:
          {{- range .Values.clusterSecrets.targetNamespaces }}
          - {{ . | quote }}
          {{- end }}
    {{- end }}

  # 갱신 주기
  refreshTime: {{ .Values.clusterSecrets.refreshInterval | default "1h" }}

  # ExternalSecret 템플릿
  externalSecretSpec:
    refreshInterval: {{ .Values.clusterSecrets.refreshInterval | default "1h" }}
    secretStoreRef:
      name: {{ .Values.clusterSecretStore.name }}
      kind: ClusterSecretStore
    target:
      name: {{ .Values.clusterSecrets.targetSecretName }}
      creationPolicy: Owner
      template:
        type: Opaque
        metadata:
          labels:
            {{- include "openbao-cluster-secrets-manager.labels" . | nindent 12 }}
            app.kubernetes.io/component: cluster-secrets
    # dataFrom을 사용하여 전체 KV 경로의 모든 키-값을 자동으로 가져옴
    # 새 환경변수 추가 시 OpenBao KV에만 추가하면 자동 동기화
    dataFrom:
      - extract:
          key: {{ .Values.clusterSecrets.remoteRef.key }}
{{- end }}
