# ClusterExternalSecret - 클러스터 전역 시크릿
# 지정된 모든 네임스페이스에 동일한 Secret을 생성
# OpenBao 경로: secret/server/cluster
{{- if .Values.clusterSecrets.enabled }}
apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: {{ .Values.clusterSecrets.name }}
  labels:
    {{- include "openbao-secrets-manager.labels" . | nindent 4 }}
    app.kubernetes.io/component: cluster-external-secret
spec:
  # 시크릿이 생성될 네임스페이스 선택
  namespaceSelector:
    {{- if .Values.clusterSecrets.namespaceSelector.matchLabels }}
    matchLabels:
      {{- toYaml .Values.clusterSecrets.namespaceSelector.matchLabels | nindent 6 }}
    {{- else }}
    # 모든 네임스페이스 또는 지정된 네임스페이스에 생성
    matchExpressions:
      - key: kubernetes.io/metadata.name
        operator: In
        values:
          {{- range .Values.clusterSecrets.targetNamespaces }}
          - {{ . | quote }}
          {{- end }}
    {{- end }}

  # 갱신 주기
  refreshTime: {{ .Values.clusterSecrets.refreshInterval | default "1h" }}

  # ExternalSecret 템플릿
  externalSecretSpec:
    refreshInterval: {{ .Values.clusterSecrets.refreshInterval | default "1h" }}
    secretStoreRef:
      name: {{ .Values.clusterSecretStore.name }}
      kind: ClusterSecretStore
    target:
      name: {{ .Values.clusterSecrets.targetSecretName }}
      creationPolicy: Owner
      template:
        type: Opaque
        metadata:
          labels:
            {{- include "openbao-secrets-manager.labels" . | nindent 12 }}
            app.kubernetes.io/component: cluster-secrets
    data:
      {{- range .Values.clusterSecrets.data }}
      - secretKey: {{ .secretKey }}
        remoteRef:
          key: {{ $.Values.clusterSecrets.remoteRef.key }}
          property: {{ .property }}
      {{- end }}
{{- end }}
