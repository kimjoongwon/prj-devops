{{- range .Values.global.namespaces }}
{{- $namespace := . }}
{{- $env := "development" }}
{{- if contains "prod" . }}
{{- $env = "production" }}
{{- else if contains "stg" . }}
{{- $env = "staging" }}
{{- end }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "openbao-secrets-manager.externalSecretName" $ }}
  namespace: {{ $namespace }}
  labels:
    {{- include "openbao-secrets-manager.labels" $ | nindent 4 }}
    app.kubernetes.io/component: external-secret
    environment: {{ $env }}
spec:
  refreshInterval: {{ $.Values.externalSecrets.externalSecret.refreshInterval }}
  secretStoreRef:
    name: {{ include "openbao-secrets-manager.secretStoreName" $ }}
    kind: SecretStore
  target:
    name: {{ include "openbao-secrets-manager.targetSecretName" $ }}
    creationPolicy: {{ $.Values.externalSecrets.externalSecret.target.creationPolicy }}
    {{- if $.Values.externalSecrets.externalSecret.target.template }}
    template:
      type: {{ $.Values.externalSecrets.externalSecret.target.template.type }}
      metadata:
        labels:
          {{- include "openbao-secrets-manager.labels" $ | nindent 10 }}
          {{- with $.Values.externalSecrets.externalSecret.target.template.metadata.labels }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
          environment: {{ $env }}
      {{- with $.Values.externalSecrets.externalSecret.target.template.data }}
      data:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- end }}
  # dataFrom을 사용하여 전체 KV 경로의 모든 키-값을 자동으로 가져옴
  # 새 환경변수 추가 시 OpenBao KV에만 추가하면 자동 동기화
  dataFrom:
    - extract:
        key: server/{{ $env }}
{{- end }}