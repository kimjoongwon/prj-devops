{{- if .Values.harbor.enabled }}
{{- range .Values.global.namespaces }}
{{- $namespace := . }}
{{- $env := if contains "prod" . }}production{{ else if contains "stg" . }}staging{{ else }}development{{ end }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "openbao-secrets-manager.harborSecretName" $ }}
  namespace: {{ $namespace }}
  labels:
    {{- include "openbao-secrets-manager.labels" $ | nindent 4 }}
    app.kubernetes.io/component: harbor-registry-secret
    environment: {{ $env }}
spec:
  refreshInterval: {{ $.Values.harbor.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "openbao-secrets-manager.secretStoreName" $ }}
    kind: SecretStore
  target:
    name: {{ $.Values.harbor.targetSecretName | default "harbor-docker-secret" }}
    template:
      type: kubernetes.io/dockerconfigjson
      metadata:
        labels:
          {{- include "openbao-secrets-manager.labels" $ | nindent 10 }}
          app.kubernetes.io/component: registry-auth
          environment: {{ $env }}
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "{{ printf "{{" }} .registry {{ printf "}}" }}": {
                "username": "{{ printf "{{" }} .username {{ printf "}}" }}",
                "password": "{{ printf "{{" }} .password {{ printf "}}" }}",
                "auth": "{{ printf "{{" }} printf "%s:%s" .username .password | b64enc {{ printf "}}" }}"
              }
            }
          }
  data:
  - secretKey: registry
    remoteRef:
      {{- if eq $env "production" }}
      key: {{ $.Values.harbor.production.remoteRef.key | default "harbor/production" }}
      {{- else if eq $env "staging" }}
      key: {{ $.Values.harbor.staging.remoteRef.key | default "harbor/staging" }}
      {{- else }}
      key: {{ $.Values.harbor.development.remoteRef.key | default "harbor/development" }}
      {{- end }}
      property: registry
  - secretKey: username
    remoteRef:
      {{- if eq $env "production" }}
      key: {{ $.Values.harbor.production.remoteRef.key | default "harbor/production" }}
      {{- else if eq $env "staging" }}
      key: {{ $.Values.harbor.staging.remoteRef.key | default "harbor/staging" }}
      {{- else }}
      key: {{ $.Values.harbor.development.remoteRef.key | default "harbor/development" }}
      {{- end }}
      property: username
  - secretKey: password
    remoteRef:
      {{- if eq $env "production" }}
      key: {{ $.Values.harbor.production.remoteRef.key | default "harbor/production" }}
      {{- else if eq $env "staging" }}
      key: {{ $.Values.harbor.staging.remoteRef.key | default "harbor/staging" }}
      {{- else }}
      key: {{ $.Values.harbor.development.remoteRef.key | default "harbor/development" }}
      {{- end }}
      property: password
{{- end }}
{{- end }}